<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crew Link Summary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
    }
    thead {
      background-color: #1e3a8a;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:nth-child(even) { background-color: #f3f4f6; }
    tbody tr:hover { background-color: #e0f2fe; }
    td[contenteditable="true"]:focus {
      background-color: #e0f2fe;
      outline: 2px solid #2563eb;
    }
    @media print {
      .no-print { display: none !important; }
    }
   
  @media print {
    thead { display: table-header-group; }
  }
  
</style>

</head>
<body class="bg-gray-100 text-sm"><main class="max-w-7xl mx-auto p-4">
 <h1 class="text-xl font-bold mb-6 text-center">Crew Link Summary</h1>
 
  <!-- Input Section -->  
  
  <div class="bg-white p-6 rounded-xl shadow-md mb-8">
  <h2 class="text-xl font-bold mb-4 text-center text-blue-800">Add New Duty</h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    
    <!-- Headquarter -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Headquarter</span>
      <select id="hqSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="MAO">MAO</option>
        <option value="RN">RN</option>
        <option value="SL">SL</option>
      </select>
    </label>

    <!-- Crew Link -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Crew Link</span>
      <select id="linkSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Link</option>
      </select>
    </label>


    <!-- Train No -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Train No</span>
      <input id="trainNo" placeholder="Train No" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </label>

    <!-- From Station -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">From Station</span>
      <select id="fromStation" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">From</option>
      </select>
    </label>

    <!-- To Station -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">To Station</span>
      <select id="toStation" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">To</option>
      </select>
    </label>

    <!-- Duty Day -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Day of Duty</span>
      <select id="dutyDay" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Day</option>
        <option>Mon</option><option>Tue</option><option>Wed</option>
        <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
      </select>
    </label>

  </div>
</div>


  <button onclick="addRow()" class="mt-4 bg-blue-600 text-white w-full sm:w-auto px-6 py-2 rounded shadow hover:bg-blue-700">
    ➕ Add Duty Row
  </button>
</div>

  </div>  
  
  <!-- PDF Export Area --> 
  
  <div id="pdfArea" class="bg-white p-4">
    <h1 id="pdfTitle" class="text-xl font-bold mb-4 text-center">Summary</h1>
    <div>
      <table id="dutyTable" class="min-w-full text-center table-auto border-collapse">
        <thead>
          <tr>
            <th>#</th><th>Train</th><th>From</th><th>To</th><th>Departure</th><th>Arrival</th>
            <th>Sign On</th><th>Sign Off</th><th>Duty Hrs</th><th>Night Hrs</th><th>KM</th>
            <th>HQ Rest</th><th>OS Rest</th><th class="no-print">🗑️</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        
        <!-- Separated Bottom Summary Table -->
<div id="summaryTableWrapper" class="mt-4">
  <table id="summaryTable" class="min-w-full text-center border-collapse">
    <thead class="bg-gray-500 font-semibold">
      <tr>
        <th colspan="8" class="text-right pr-2">Summary Type</th>
        <th>Duty Hrs</th>
        <th>Night Hrs</th>
        <th>KM</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Avg / Day</td>
        <td id="avgDuty">--</td>
        <td id="avgNight">--</td>
        <td id="avgKm">--</td>
      </tr>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Fortnight</td>
        <td id="fortnightDuty">--</td>
        <td id="fortnightNight">--</td>
        <td id="fortnightKm">--</td>
      </tr>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Month</td>
        <td id="monthDuty">--</td>
        <td id="monthNight">--</td>
        <td id="monthKm">--</td>
      </tr>
      <tr class="bg-yellow-100 font-bold">
        <td colspan="8" class="text-right pr-2">Total</td>
        <td id="totalDuty">--</td>
        <td id="totalNight">--</td>
        <td id="totalKm">--</td>
      </tr>
    </tbody>
  </table>
</div>



      </table>
    </div>
    
    </div>

 
  
<div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
  <button onclick="exportExcel()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700">
    📊 Export to Excel
  </button>
  <button onclick="exportPDF()" class="bg-red-600 text-white px-6 py-2 rounded shadow hover:bg-red-700">
    🧾 Export to PDF
  </button>
</div>


  

</main>

<script>
const trainTimings = {
    "MAO-MAQ": [
      { train: "20645", dep: "17:35", arr: "22:45" },
      { train: "12619", dep: "02:35", arr: "10:20" },
      { train: "56615", dep: "14:15", arr: "21:55" },
      { train: "SP/56615", dep: "14:15", arr: "21:55" },
      { train: "SP/20645", dep: "17:35", arr: "22:45" },
      { train: "SP/10107/10107", dep: "04:40", arr: "12:30" }
    ],
    "MAQ-MAO": [
      { train: "20646", dep: "08:30", arr: "14:10" },
      { train: "56616", dep: "05:30", arr: "13:30" },
      { train: "12620", dep: "12:45", arr: "19:30" },
      { train: "10108/SP", dep: "15:30", arr: "23:15" },
      { train: "16585/SP", dep: "08:40", arr: "19:30" },
      { train: "SP/20646", dep: "08:30", arr: "14:10" },
      { train: "12789/SP", dep: "09:30", arr: "19:30" }
    ],
    "MAO-RN": [
      { train: "12052", dep: "12:00", arr: "17:20" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "12431", dep: "08:00", arr: "12:40" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22907", dep: "10:00", arr: "14:45" },
      { train: "12977", dep: "09:20", arr: "14:45" },
      { train: "22633", dep: "08:00", arr: "12:45" },
      { train: "12224", dep: "09:55", arr: "15:25" },
      { train: "16334", dep: "10:50", arr: "16:05" },
      { train: "16336", dep: "10:50", arr: "16:05" },
      { train: "16338", dep: "10:50", arr: "16:05" },
      { train: "19259", dep: "10:50", arr: "16:05" },
      { train: "16312", dep: "10:50", arr: "16:05" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22149", dep: "15:50", arr: "20:20" },
      { train: "22655", dep: "15:50", arr: "20:20" },
      { train: "22653", dep: "15:50", arr: "20:20" },
      { train: "22114", dep: "18:20", arr: "23:20" },
      { train: "12620", dep: "19:40", arr: "23:30" },
      { train: "12134", dep: "22:10", arr: "02:20" },
      { train: "12217", dep: "23:40", arr: "04:50" },
      { train: "22659", dep: "23:40", arr: "04:50" },
      { train: "12483", dep: "23:40", arr: "04:50" },
      { train: "12617", dep: "01:20", arr: "06:00" },
      { train: "12202", dep: "01:55", arr: "06:50" },
      { train: "19577", dep: "02:25", arr: "07:55" },
      { train: "22630", dep: "04:25", arr: "09:55" },
      { train: "20923", dep: "02:40", arr: "07:55" },
      { train: "20931", dep: "02:40", arr: "07:55" },
      { train: "20909", dep: "02:40", arr: "07:55" },
      { train: "22476", dep: "02:40", arr: "07:55" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "10116", dep: "07:40", arr: "13:30" },
      { train: "10104", dep: "08:30", arr: "14:00" },
      { train: "22414", dep: "08:00", arr: "12:40" },
      { train: "20907", dep: "10:00", arr: "14:45" },
      { train: "12449", dep: "10:00", arr: "14:45" },
      { train: "11100", dep: "11:30", arr: "16:30" },
      { train: "22230", dep: "12:20", arr: "16:55" },
      { train: "22120", dep: "12:50", arr: "18:05" },
      { train: "20112", dep: "18:00", arr: "22:50" },
      { train: "12741", dep: "20:05", arr: "00:40" },
      { train: "22413", dep: "08:00", arr: "12:40" },
      { train: "02197", dep: "05:35", arr: "10:25" },
      { train: "50108/10106", dep: "06:20", arr: "12:00" }
      
        ],
  
    "RN-MAO": [
      { train: "12051", dep: "11:25", arr: "16:40" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22150", dep: "02:25", arr: "06:45" },
      { train: "12133", dep: "04:20", arr: "09:00" },
      { train: "22656", dep: "06:55", arr: "12:30" },
      { train: "12432", dep: "03:55", arr: "08:25" },
      { train: "22414", dep: "03:55", arr: "08:35" },
      { train: "16333", dep: "05:15", arr: "10:40" },
      { train: "16335", dep: "05:15", arr: "10:40" },
      { train: "16337", dep: "05:15", arr: "10:40" },
      { train: "19260", dep: "05:15", arr: "10:40" },
      { train: "20111", dep: "06:05", arr: "11:40" },
      { train: "22654", dep: "06:55", arr: "12:30" },
      { train: "12450", dep: "07:30", arr: "13:30" },
      { train: "11099", dep: "08:25", arr: "14:40" },
      { train: "12978", dep: "10:45", arr: "15:50" },
      { train: "22229", dep: "10:45", arr: "16:00" },
      { train: "22119", dep: "12:05", arr: "17:20" },
      { train: "12618", dep: "12:45", arr: "17:50" },
      { train: "12484", dep: "13:25", arr: "18:25" },
      { train: "22660", dep: "13:25", arr: "18:25" },
      { train: "12218", dep: "13:25", arr: "18:25" },
      { train: "10103", dep: "14:50", arr: "21:55" },
      { train: "10115", dep: "16:10", arr: "22:40" },
      { train: "20932", dep: "17:00", arr: "22:50" },
      { train: "20910", dep: "17:00", arr: "22:50" },
      { train: "19578", dep: "17:00", arr: "22:50" },
      { train: "16345", dep: "18:35", arr: "23:45" },
      { train: "22908", dep: "17:00", arr: "22:50" },
      { train: "16311", dep: "20:35", arr: "01:45" },
      { train: "22475", dep: "20:35", arr: "01:45" },
      { train: "12284", dep: "20:35", arr: "01:45" },
      { train: "12619", dep: "21:35", arr: "02:25" },
      { train: "20924", dep: "22:10", arr: "03:10" },
      { train: "22634", dep: "22:10", arr: "03:10" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22113", dep: "23:35", arr: "04:00" },
      { train: "12742", dep: "23:35", arr: "04:00" },
      { train: "12223", dep: "02:25", arr: "06:20" },
      { train: "20629", dep: "03:15", arr: "08:25" },
      { train: "20932", dep: "17:00", arr: "23:00" },
      { train: "22629", dep: "03:15", arr: "08:25" },
      { train: "09057", dep: "06:25", arr: "12:20" },
      { train: "10105/50107", dep: "14:05", arr: "21:30" }
      
    ],
    
    "MAO-MAJN": [
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22629", dep: "08:35", arr: "14:05" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "10215", dep: "21:00", arr: "03:00" },
  { train: "12432", dep: "08:35", arr: "14:05" },
  { train: "12133", dep: "09:10", arr: "15:40" },
  { train: "16333", dep: "10:50", arr: "17:55" },
  { train: "16335", dep: "10:50", arr: "17:55" },
  { train: "16337", dep: "10:50", arr: "17:55" },
  { train: "19260", dep: "10:50", arr: "17:55" },
  { train: "22654", dep: "12:40", arr: "18:15" },
  { train: "22656", dep: "12:40", arr: "18:15" },
  { train: "12978", dep: "16:00", arr: "21:45" },
  { train: "12618", dep: "18:00", arr: "23:35" },
  { train: "12484", dep: "18:35", arr: "01:10" },
  { train: "22660", dep: "18:35", arr: "01:10" },
  { train: "12218", dep: "18:35", arr: "01:10" },
  { train: "20932", dep: "23:00", arr: "04:10" },
  { train: "20910", dep: "23:00", arr: "04:10" },
  { train: "19578", dep: "23:00", arr: "04:10" },
  { train: "16345", dep: "23:55", arr: "05:45" },
  { train: "16311", dep: "01:55", arr: "09:15" },
  { train: "22475", dep: "01:55", arr: "09:15" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "20924", dep: "03:20", arr: "09:45" },
  { train: "22634", dep: "03:20", arr: "09:45" },
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22113", dep: "04:10", arr: "10:25" },
  { train: "12223", dep: "06:30", arr: "12:15" },
  { train: "22150", dep: "06:55", arr: "13:45" },
  { train: "11097", dep: "13:10", arr: "19:20" },
  { train: "09057", dep: "12:30", arr: "19:45" },
  { train: "SP/16345", dep: "23:55", arr: "05:45" }
  
  ],
    "MAJN-MAO": [
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "12431", dep: "01:50", arr: "07:50" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12977", dep: "01:50", arr: "09:10" },
      { train: "22633", dep: "01:55", arr: "07:50" },
      { train: "12224", dep: "04:00", arr: "09:45" },
      { train: "16334", dep: "04:10", arr: "10:40" },
      { train: "16336", dep: "04:10", arr: "10:40" },
      { train: "16338", dep: "04:10", arr: "10:40" },
      { train: "19259", dep: "04:10", arr: "10:40" },
      { train: "16312", dep: "04:10", arr: "10:50" },
      { train: "12283", dep: "06:05", arr: "11:25" },
      { train: "22149", dep: "09:25", arr: "15:40" },
      { train: "22655", dep: "09:30", arr: "15:40" },
      { train: "22653", dep: "09:30", arr: "15:40" },
      { train: "22114", dep: "12:00", arr: "18:10" },
      { train: "12134", dep: "16:35", arr: "22:00" },
      { train: "12217", dep: "17:10", arr: "23:30" },
      { train: "22659", dep: "17:10", arr: "23:30" },
      { train: "12483", dep: "17:10", arr: "23:30" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12202", dep: "19:15", arr: "01:45" },
      { train: "19577", dep: "20:00", arr: "02:15" },
      { train: "22630", dep: "22:00", arr: "04:15" },
      { train: "20923", dep: "20:00", arr: "02:30" },
      { train: "20931", dep: "20:00", arr: "02:30" },
      { train: "20909", dep: "20:00", arr: "02:30" },
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "11098", dep: "01:55", arr: "09:30" },
      { train: "10216", dep: "20:20", arr: "03:30" },
      { train: "SP/16312", dep: "04:10", arr: "10:50" },
      { train: "SP/56616", dep: "05:45", arr: "13:30" },
      { train: "02197", dep: "23:10", arr: "05:25" },
      { train: "09058", dep: "22:10", arr: "05:10" }
    ],
    "RN-SWV": [
      { train: "11003", dep: "09:05", arr: "12:50" }
    ],
     "SWV-RN": [
      { train: "11004", dep: "17:55", arr: "21:30" }
    ],
     "RN-KRMI": [
      { train: "22115", dep: "07:30", arr: "12:25" }
    ],
     "KRMI-RN": [
      { train: "22116", dep: "13:40", arr: "18:05" }
    ],
    "SL-MAO": [
      { train: "16595/01595", dep: "03:37", arr: "10:25" },
      { train: "SP/56616", dep: "06:28", arr: "13:30" },
      { train: "SP/12134", dep: "17:08", arr: "22:00" }
    ],
    "SL-MAQ": [
      { train: "16585/16586", dep: "09:50", arr: "18:25" }
      
    ],
    "MAO-SL": [
      { train: "01596/16596", dep: "16:30", arr: "21:54" }
    ],
    "MAQ-SL": [
      { train: "16585", dep: "08:40", arr: "09:48" }
    ],
     "MAO-MRDW": [
      { train: "10107", dep: "04:40", arr: "07:42" },
      { train: "SP/10107", dep: "04:40", arr: "07:42" }
    ],
     "MRDW-MAO": [
      { train: "10108", dep: "18:41", arr: "23:15" },
      { train: "SP/10108", dep: "18:41", arr: "23:15" }
      
    ],
     "MRDW-MAQ": [
      { train: "16586", dep: "14:25", arr: "18:25" },
      { train: "12790", dep: "15:45", arr: "19:45" },
      { train: "10107", dep: "07:43", arr: "12:20" }
      
    ],
     "MAQ-MRDW": [
      { train: "10108", dep: "15:30", arr: "18:40" },
      { train: "16585", dep: "08:40", arr: "13:50" },
      { train: "12789", dep: "09:30", arr: "15:10" }
    ],
     "RN-ROH": [
      { train: "10106", dep: "12:05", arr: "17:20" },
      { train: "50104", dep: "05:40", arr: "10:55" }
    ],
     "ROH-RN": [
      { train: "50103", dep: "20:12", arr: "02:00" },
      { train: "10105", dep: "09:05", arr: "14:00" }
    ],
    "MAO-VSG": [
      { train: "12742", dep: "04:15", arr: "05:45" }
    ],
    
    "VSG-MAO": [
      { train: "12741", dep: "19:00", arr: "19:50" }
      ],
     "MAO-KAWR": [
      { train: "70101", dep: "19:00", arr: "20:30" }
    ],
     "KAWR-MAO": [
      { train: "70102", dep: "06:00", arr: "07:15" }
    ],
    
         "MAQ-SL": [
      { train: "16585", dep: "08:40", arr: "09:48" }
    ]
    
};

const crewLinkMen = {
  MAO: {
    "Link 1": 18,
    "Link 2": 15,
    "Link 3": 10,
    "Link 4": 17
  },
  RN: {
    "Link 1": 14,
    "Link 2": 17,
    "Link 3": 15
  },
  SL: {
    "Link 1": 2
  }
};



// ✅ Constants
const stations = ['MAO', 'RN', 'MAJN', 'MAQ', 'MRDW', 'SL', 'KAWR', 'ROH', 'VSG'];
const kmMap = {
  'MAO-RN': 239, 'RN-MAO': 239,
  'MAO-MAJN': 312, 'MAJN-MAO': 312,
  'MAO-MAQ': 318, 'MAQ-MAO': 318,
  'MAO-MRDW': 154, 'MRDW-MAO': 154,
  'MAO-KAWR': 120, 'KAWR-MAO': 120,
  'MAQ-MRDW': 164, 'MRDW-MAQ': 164,
  'MAO-SL': 294, 'SL-MAO': 294
};

const crewLinksByHQ = {
  MAO: ["Link 1", "Link 2", "Link 3", "Link 4"],
  RN: ["Link 1", "Link 2", "Link 3"],
  SL: ["Link 1"]
};

const crewLinkData = { MAO: {}, RN: {}, SL: {} };
const dayToIndex = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };

function parseTime(t) {
  let [h, m] = t.split(":" ).map(Number);
  if (h === 24 && m === 0) return 0;
  return h * 60 + m;
}

function formatTime(mins) {
  if (isNaN(mins)) return "--";
  const h = Math.floor(mins / 60).toString().padStart(2, '0');
  const m = (mins % 60).toString().padStart(2, '0');
  return `${h}:${m}`;
}

function parseDayTime(dayStr, timeStr) {
  const [hRaw, mRaw] = timeStr.split(':').map(Number);
  const base = new Date(Date.UTC(2025, 0, 5));
  base.setUTCDate(base.getUTCDate() + dayToIndex[dayStr]);
  base.setUTCHours(hRaw % 24, mRaw, 0, 0);
  if (hRaw === 24 && mRaw === 0) base.setUTCDate(base.getUTCDate() + 1);
  return base;
}

function getRestMinutes(prevDay, prevSignOff, currDay, currSignOn) {
  const prevDate = parseDayTime(prevDay, prevSignOff);
  const currDate = parseDayTime(currDay, currSignOn);
  let diff = (currDate - prevDate) / 60000;
  if (diff < 0) diff += 7 * 1440;
  return diff;
}

function calcNightHours(start, end) {
  let total = 0;
  for (let i = 0; i < (end - start + 1440) % 1440; i++) {
    const min = (start + i) % 1440;
  
