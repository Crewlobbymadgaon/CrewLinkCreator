<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crew Link Summary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Required Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
    }
    thead {
      background-color: #1e3a8a;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:nth-child(even) { background-color: #f3f4f6; }
    tbody tr:hover { background-color: #e0f2fe; }
    td[contenteditable="true"]:focus {
      background-color: #e0f2fe;
      outline: 2px solid #2563eb;
    }
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="bg-gray-100 text-sm"><main class="max-w-7xl mx-auto p-4">
 <h1 class="text-xl font-bold mb-6 text-center">Crew Link Summary</h1>
 
  <!-- Input Section -->  
  
  <div class="bg-white p-4 rounded shadow-md mb-6">
  <h2 class="text-lg font-semibold mb-3 text-center">Add New Duty</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    
    <label>
      <span class="block text-sm font-medium mb-1">Headquarter</span>
      <select id="hqSelect" class="w-full p-2 border rounded">
        <option value="MAO">MAO</option>
        <option value="RN">RN</option>
        <option value="SL">SL</option>
      </select>
    </label>

    <label>
      <span class="block text-sm font-medium mb-1">Crew Link</span>
      <select id="linkSelect" class="w-full p-2 border rounded">
        <option value="">Select Link</option>
      </select>
    </label>

    <label>
      <span class="block text-sm font-medium mb-1">Train No</span>
      <input id="trainNo" placeholder="Train No" class="w-full p-2 border rounded"/>
    </label>

    <label>
      <span class="block text-sm font-medium mb-1">From Station</span>
      <select id="fromStation" class="w-full p-2 border rounded">
        <option value="">From</option>
      </select>
    </label>

    <label>
      <span class="block text-sm font-medium mb-1">To Station</span>
      <select id="toStation" class="w-full p-2 border rounded">
        <option value="">To</option>
      </select>
    </label>

    <label>
      <span class="block text-sm font-medium mb-1">Day of Duty</span>
      <select id="dutyDay" class="w-full p-2 border rounded">
        <option value="">Select Day</option>
        <option>Mon</option><option>Tue</option><option>Wed</option>
        <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
      </select>
    </label>

  </div>

  <button onclick="addRow()" class="mt-4 bg-blue-600 text-white w-full sm:w-auto px-6 py-2 rounded shadow hover:bg-blue-700">
    ➕ Add Duty Row
  </button>
</div>

  </div>  
  
  <!-- PDF Export Area --> 
  
  <div id="pdfArea" class="bg-white p-4">
    <h1 id="pdfTitle" class="text-xl font-bold mb-4 text-center">Summary</h1>
    <div class="overflow-auto">
      <table id="dutyTable" class="min-w-full text-center table-auto border-collapse">
        <thead>
          <tr>
            <th>#</th><th>Train</th><th>From</th><th>To</th><th>Departure</th><th>Arrival</th>
            <th>Sign On</th><th>Sign Off</th><th>Duty Hrs</th><th>Night Hrs</th><th>KM</th>
            <th>HQ Rest</th><th>OS Rest</th><th class="no-print">🗑️</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot class="bg-gray-200 font-semibold">
          <tr><td colspan="8" class="text-right pr-4">Daily Avg:</td><td id="avgDuty">--</td><td id="avgNight">--</td><td id="avgKm">--</td><td colspan="2"></td></tr>
          <tr><td colspan="8" class="text-right pr-4">Fortnight Total:</td><td id="fortnightDuty">--</td><td id="fortnightNight">--</td><td id="fortnightKm">--</td><td colspan="2"></td></tr>
          <tr><td colspan="8" class="text-right pr-4">Monthly Total:</td><td id="monthDuty">--</td><td id="monthNight">--</td><td id="monthKm">--</td><td colspan="2"></td></tr>
        </tfoot>
      </table>
    </div>
  </div>
  
<div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
  <button onclick="exportExcel()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700">
    📊 Export to Excel
  </button>
  <button onclick="exportPDF()" class="bg-red-600 text-white px-6 py-2 rounded shadow hover:bg-red-700">
    🧾 Export to PDF
  </button>
</div>

</main>

<script>
const trainTimings = {
    "MAO-MAQ": [
      { train: "20645", dep: "17:35", arr: "22:45" },
      { train: "12619", dep: "02:35", arr: "10:20" },
      { train: "56615", dep: "14:15", arr: "21:55" }
    ],
    "MAQ-MAO": [
      { train: "20646", dep: "08:30", arr: "14:10" },
      { train: "56616", dep: "05:30", arr: "13:30" },
      { train: "12620", dep: "12:45", arr: "19:30" }
    ],
    "MAO-RN": [
      { train: "12052", dep: "12:00", arr: "17:20" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "12431", dep: "08:00", arr: "12:40" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22907", dep: "10:00", arr: "14:45" },
      { train: "12977", dep: "09:20", arr: "14:45" },
      { train: "22633", dep: "08:00", arr: "12:45" },
      { train: "12224", dep: "09:55", arr: "15:25" },
      { train: "16334", dep: "10:50", arr: "16:05" },
      { train: "16336", dep: "10:50", arr: "16:05" },
      { train: "16338", dep: "10:50", arr: "16:05" },
      { train: "19259", dep: "10:50", arr: "16:05" },
      { train: "16312", dep: "10:50", arr: "16:05" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22149", dep: "15:50", arr: "20:20" },
      { train: "22655", dep: "15:50", arr: "20:20" },
      { train: "22653", dep: "15:50", arr: "20:20" },
      { train: "22114", dep: "18:20", arr: "23:20" },
      { train: "12620", dep: "19:40", arr: "23:30" },
      { train: "12134", dep: "22:10", arr: "02:20" },
      { train: "12217", dep: "23:40", arr: "04:50" },
      { train: "22659", dep: "23:40", arr: "04:50" },
      { train: "12483", dep: "23:40", arr: "04:50" },
      { train: "12617", dep: "01:20", arr: "06:00" },
      { train: "12202", dep: "01:55", arr: "06:50" },
      { train: "19577", dep: "02:25", arr: "07:55" },
      { train: "22630", dep: "04:25", arr: "09:55" },
      { train: "20923", dep: "02:40", arr: "07:55" },
      { train: "20931", dep: "02:40", arr: "07:55" },
      { train: "20909", dep: "02:40", arr: "07:55" },
      { train: "22476", dep: "02:40", arr: "07:55" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "10116", dep: "07:40", arr: "13:30" },
      { train: "10104", dep: "08:30", arr: "14:00" },
      { train: "22414", dep: "08:00", arr: "12:40" },
      { train: "20907", dep: "10:00", arr: "14:45" },
      { train: "12449", dep: "10:00", arr: "14:45" },
      { train: "11100", dep: "11:30", arr: "16:30" },
      { train: "22230", dep: "12:20", arr: "16:55" },
      { train: "22120", dep: "12:50", arr: "18:05" },
      { train: "20112", dep: "18:00", arr: "22:50" },
      { train: "12741", dep: "20:05", arr: "00:40" },
      { train: "22413", dep: "08:00", arr: "12:40" },
      { train: "02197", dep: "05:35", arr: "10:25" }
      
        ],
  
    "RN-MAO": [
      { train: "12051", dep: "11:25", arr: "16:40" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22150", dep: "02:25", arr: "06:45" },
      { train: "12133", dep: "04:20", arr: "09:00" },
      { train: "22656", dep: "06:55", arr: "12:30" },
      { train: "12432", dep: "03:55", arr: "08:25" },
      { train: "22414", dep: "03:55", arr: "08:35" },
      { train: "16333", dep: "05:15", arr: "10:40" },
      { train: "16335", dep: "05:15", arr: "10:40" },
      { train: "16337", dep: "05:15", arr: "10:40" },
      { train: "19260", dep: "05:15", arr: "10:40" },
      { train: "20111", dep: "06:05", arr: "11:40" },
      { train: "22654", dep: "06:55", arr: "12:30" },
      { train: "12450", dep: "07:30", arr: "13:30" },
      { train: "11099", dep: "08:25", arr: "14:40" },
      { train: "12978", dep: "10:45", arr: "15:50" },
      { train: "22229", dep: "10:45", arr: "16:00" },
      { train: "22119", dep: "12:05", arr: "17:20" },
      { train: "12618", dep: "12:45", arr: "17:50" },
      { train: "12484", dep: "13:25", arr: "18:25" },
      { train: "22660", dep: "13:25", arr: "18:25" },
      { train: "12218", dep: "13:25", arr: "18:25" },
      { train: "10103", dep: "14:50", arr: "21:55" },
      { train: "10115", dep: "16:10", arr: "22:40" },
      { train: "20932", dep: "17:00", arr: "22:50" },
      { train: "20910", dep: "17:00", arr: "22:50" },
      { train: "19578", dep: "17:00", arr: "22:50" },
      { train: "16345", dep: "18:35", arr: "23:45" },
      { train: "22908", dep: "17:00", arr: "22:50" },
      { train: "16311", dep: "20:35", arr: "01:45" },
      { train: "22475", dep: "20:35", arr: "01:45" },
      { train: "12284", dep: "20:35", arr: "01:45" },
      { train: "12619", dep: "21:35", arr: "02:25" },
      { train: "20924", dep: "22:10", arr: "03:10" },
      { train: "22634", dep: "22:10", arr: "03:10" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22113", dep: "23:35", arr: "04:00" },
      { train: "12742", dep: "23:35", arr: "04:00" },
      { train: "12223", dep: "02:25", arr: "06:20" },
      { train: "20629", dep: "03:15", arr: "08:25" },
      { train: "20932", dep: "17:00", arr: "23:00" }
      
    ],
    
    "MAO-MAJN": [
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22629", dep: "08:35", arr: "14:05" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "10215", dep: "21:00", arr: "03:00" },
  { train: "12432", dep: "08:35", arr: "14:05" },
  { train: "12133", dep: "09:10", arr: "15:40" },
  { train: "16333", dep: "10:50", arr: "17:55" },
  { train: "16335", dep: "10:50", arr: "17:55" },
  { train: "16337", dep: "10:50", arr: "17:55" },
  { train: "19260", dep: "10:50", arr: "17:55" },
  { train: "22654", dep: "12:40", arr: "18:15" },
  { train: "22656", dep: "12:40", arr: "18:15" },
  { train: "12978", dep: "16:00", arr: "21:45" },
  { train: "12618", dep: "18:00", arr: "23:35" },
  { train: "12484", dep: "18:35", arr: "01:10" },
  { train: "22660", dep: "18:35", arr: "01:10" },
  { train: "12218", dep: "18:35", arr: "01:10" },
  { train: "20932", dep: "23:00", arr: "04:10" },
  { train: "20910", dep: "23:00", arr: "04:10" },
  { train: "19578", dep: "23:00", arr: "04:10" },
  { train: "16345", dep: "23:55", arr: "05:45" },
  { train: "16311", dep: "01:55", arr: "09:15" },
  { train: "22475", dep: "01:55", arr: "09:15" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "20924", dep: "03:20", arr: "09:45" },
  { train: "22634", dep: "03:20", arr: "09:45" },
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22113", dep: "04:10", arr: "10:25" },
  { train: "12223", dep: "06:30", arr: "12:15" },
  { train: "22150", dep: "06:55", arr: "13:45" },
  { train: "11097", dep: "13:10", arr: "19:20" }
  
  ],
    "MAJN-MAO": [
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "12431", dep: "01:50", arr: "07:50" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12977", dep: "01:50", arr: "09:10" },
      { train: "22633", dep: "01:55", arr: "07:50" },
      { train: "12224", dep: "04:00", arr: "09:45" },
      { train: "16334", dep: "04:10", arr: "10:40" },
      { train: "16336", dep: "04:10", arr: "10:40" },
      { train: "16338", dep: "04:10", arr: "10:40" },
      { train: "19259", dep: "04:10", arr: "10:40" },
      { train: "16312", dep: "04:10", arr: "10:50" },
      { train: "12283", dep: "06:05", arr: "11:25" },
      { train: "22149", dep: "09:25", arr: "15:40" },
      { train: "22655", dep: "09:30", arr: "15:40" },
      { train: "22653", dep: "09:30", arr: "15:40" },
      { train: "22114", dep: "12:00", arr: "18:10" },
      { train: "12134", dep: "16:35", arr: "22:00" },
      { train: "12217", dep: "17:10", arr: "23:30" },
      { train: "22659", dep: "17:10", arr: "23:30" },
      { train: "12483", dep: "17:10", arr: "23:30" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12202", dep: "19:15", arr: "01:45" },
      { train: "19577", dep: "20:00", arr: "02:15" },
      { train: "22630", dep: "22:00", arr: "04:15" },
      { train: "20923", dep: "20:00", arr: "02:30" },
      { train: "20931", dep: "20:00", arr: "02:30" },
      { train: "20909", dep: "20:00", arr: "02:30" },
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "11098", dep: "01:55", arr: "09:30" },
      { train: "10216", dep: "20:20", arr: "03:30" }
    ],
    "RN-SWV": [
      { train: "11003", dep: "09:05", arr: "12:50" }
    ],
     "SWV-RN": [
      { train: "11004", dep: "17:55", arr: "21:30" }
    ],
     "RN-KRMI": [
      { train: "22115", dep: "07:30", arr: "12:25" }
    ],
     "KRMI-RN": [
      { train: "22116", dep: "13:40", arr: "18:05" }
    ],
    "SL-MAO": [
      { train: "16595/01595", dep: "03:37", arr: "10:25" }
    ],
    "MAO-SL": [
      { train: "01596/16596", dep: "16:30", arr: "22:30" }
    ],
     "MAO-MRDW": [
      { train: "10107", dep: "04:40", arr: "07:42" },
      { train: "SP/10107", dep: "04:40", arr: "07:42" }
    ],
     "MRDW-MAO": [
      { train: "10108", dep: "18:41", arr: "23:15" },
      { train: "SP/10108", dep: "18:41", arr: "23:15" }
      
    ],
     "MRDW-MAQ": [
      { train: "16586", dep: "14:25", arr: "18:25" },
      { train: "12790", dep: "15:45", arr: "19:45" },
      { train: "10107", dep: "07:43", arr: "12:20" }
      
    ],
     "MAQ-MRDW": [
      { train: "10108", dep: "15:30", arr: "18:40" },
      { train: "16585", dep: "08:40", arr: "13:50" },
      { train: "12789", dep: "09:30", arr: "15:10" }
    ],
     "RN-ROH": [
      { train: "10106", dep: "12:05", arr: "17:20" },
      { train: "50104", dep: "05:40", arr: "10:55" }
    ],
     "ROH-RN": [
      { train: "50103", dep: "20:12", arr: "02:00" },
      { train: "10105", dep: "09:05", arr: "14:00" }
    ],
    "MAO-VSG": [
      { train: "12742", dep: "04:15", arr: "05:45" }
    ],
    
    "VSG-MAO": [
      { train: "12741", dep: "19:00", arr: "19:50" }
      ],
     "MAO-KAWR": [
      { train: "70101", dep: "19:00", arr: "20:30" }
    ],
     "KAWR-MAO": [
      { train: "70102", dep: "06:00", arr: "07:15" }
    ],
    
         "MAQ-SL": [
      { train: "16585", dep: "08:40", arr: "09:48" }
    ]
    
};


const stations = ['MAO', 'RN', 'MAJN', 'MAQ', 'MRDW', 'SL', 'KAWR', 'ROH'];
const kmMap = {
  'MAO-RN': 239, 'RN-MAO': 239,
  'MAO-MAJN': 312, 'MAJN-MAO': 312,
  'MAO-MAQ': 318, 'MAQ-MAO': 318,
  'MAO-MRDW': 154, 'MRDW-MAO': 154,
  'MAO-KAWR': 120, 'KAWR-MAO': 120,
  'MAQ-MRDW': 164, 'MRDW-MAQ': 164,
  'MAO-SL': 294, 'SL-MAO': 294
};

const crewLinksByHQ = {
  MAO: ["Link 1", "Link 2", "Link 3", "Link 4"],
  RN: ["Link 1", "Link 2", "Link 3"],
  SL: ["Link 1"]
};

const crewLinkData = { MAO: {}, RN: {}, SL: {} };

const dayToIndex = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };

function parseTime(t) {
  let [h, m] = t.split(":").map(Number);
  if (h === 24 && m === 0) return 0;
  return h * 60 + m;
}


function formatTime(mins) {
  if (isNaN(mins)) return "--";
  const h = Math.floor(mins / 60).toString().padStart(2, '0');
  const m = (mins % 60).toString().padStart(2, '0');
  return `${h}:${m}`;
}

function parseDayTime(dayStr, timeStr) {
  const [hRaw, mRaw] = timeStr.split(':').map(Number);
  let h = hRaw, m = mRaw;
  if ((h === 24 && m === 0) || (h === 23 && m > 59)) {
    h = 0; m = 0;
  }

  const base = new Date(Date.UTC(2025, 0, 5)); // Sunday base
  base.setUTCDate(base.getUTCDate() + dayToIndex[dayStr]);
  base.setUTCHours(h, m, 0, 0);

  // Handle 24:00 = next day 00:00
  if (hRaw === 24 && m === 0) base.setUTCDate(base.getUTCDate() + 1);

  return base;
}


function getRestMinutes(prevDay, prevSignOff, currDay, currSignOn) {
  const prevDate = parseDayTime(prevDay, prevSignOff);
  const currDate = parseDayTime(currDay, currSignOn);

  let diff = (currDate - prevDate) / 60000; // convert to minutes

  if (diff < 0) {
    diff += 7 * 1440; // If negative (week wraparound), add full week
  }

  return diff;
}

function calcNightHours(start, end) {
  let total = 0;
  for (let i = 0; i < (end - start + 1440) % 1440; i++) {
    const min = (start + i) % 1440;
    if (min >= 1320 || min < 360) total++;
  }
  return total;
}


function populateStationDropdowns() {
  fromStation.innerHTML = '<option value="">From</option>';
  toStation.innerHTML = '<option value="">To</option>';
  stations.forEach(st => {
    fromStation.innerHTML += `<option value="${st}">${st}</option>`;
    toStation.innerHTML += `<option value="${st}">${st}</option>`;
  });
}

function getTrainTiming(hq, from, to, trainNo) {
  const routeKey = `${from}-${to}`;
  const trainList = trainTimings[hq]?.[routeKey];

  if (!trainList) return null;

  return trainList.find(t => t.train === trainNo) || null;
}

function adjustSignOffDay(startDay, depTime, signOffTime) {
  const depMin = parseTime(depTime);
  const signOffMin = parseTime(signOffTime);
  let shift = 0;

  if (signOffMin < depMin) {
    shift = 1; // next day
  }

  const newIndex = (dayToIndex[startDay] + shift) % 7;
  return Object.keys(dayToIndex).find(k => dayToIndex[k] === newIndex);
}


function addRow() {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const train = trainNo.value.trim();
  const from = fromStation.value;
  const to = toStation.value;
  const day = dutyDay.value;

  if (!hq || !link || !train || !from || !to || !day) {
    return alert("Fill all fields");
  }

  const directionKey = `${from}-${to}`;
  const timingsList = trainTimings[directionKey] || [];
  const timing = timingsList.find(t => t.train === train);

  if (!timing) {
    return alert("Train timing not found for selected HQ and route.");
  }

  const dep = timing.dep;
  const arr = timing.arr;

  let signOnMin = parseTime(dep) - 30;
  if (signOnMin < 0) signOnMin += 1440;

  let signOffMin = parseTime(arr) + 30;
  if (signOffMin >= 1440) signOffMin -= 1440;

  const signOn = formatTime(signOnMin);
  const signOff = formatTime(signOffMin);
  let dutyMin = signOffMin - signOnMin;
  if (dutyMin < 0) dutyMin += 1440;
  const duty = formatTime(dutyMin);
  const night = formatTime(calcNightHours(signOnMin, signOffMin));
  const km = kmMap[`${from}-${to}`] || '--';

  if (!crewLinkData[hq][link]) crewLinkData[hq][link] = [];
  const data = crewLinkData[hq][link];

  // Rest calculation
  let hqRest = '--', osRest = '--';
  if (data.length > 0) {
    const prev = data[data.length - 1];
    const prevDepDay = prev[12];
    const prevDepTime = prev[3];
    const prevSignOff = prev[6];
    const prevTo = prev[2];

    const actualPrevSignOffDay = adjustSignOffDay(prevDepDay, prevDepTime, prevSignOff);
    const restMin = getRestMinutes(actualPrevSignOffDay, prevSignOff, day, signOn);

    if (prevTo === hq && from === hq) hqRest = formatTime(restMin);
    else osRest = formatTime(restMin);
  }

  const row = [train, from, to, dep, arr, signOn, signOff, duty, night, km, hqRest, osRest, day];
  data.push(row);
  saveToLocalStorage(hq, link);
  loadCrewLinkData(hq, link);

  // Clear inputs
  trainNo.value = '';
  fromStation.value = '';
  toStation.value = '';
  dutyDay.value = '';
}

function updateRow(td, rowIndex) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const colIndex = parseInt(td.dataset.col);
  const newValue = td.textContent.trim();

  if (!crewLinkData[hq][link]) return;

  // Update the data
  crewLinkData[hq][link][rowIndex][colIndex] = newValue;

  // Always recalculate the current row if any key field changes
  if ([3, 4, 5, 6, 12].includes(colIndex)) {
    recalculateRow(rowIndex);
    updateRowDisplay(rowIndex);

    // Also recalculate the next row, as rest depends on current Sign Off
    if (crewLinkData[hq][link][rowIndex + 1]) {
      recalculateRow(rowIndex + 1);
      updateRowDisplay(rowIndex + 1);
    }
  }

  saveToLocalStorage(hq, link);
}
function saveToLocalStorage(hq, link) {
  if (crewLinkData[hq] && crewLinkData[hq][link]) {
    localStorage.setItem(`crewData-${hq}-${link}`, JSON.stringify(crewLinkData[hq][link]));
  }
}

linkSelect.addEventListener("change", () => {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  pdfTitle.textContent = `${hq} ${link} - Summary`;
  loadCrewLinkData(hq, link);
});
document.getElementById("hqSelect").dispatchEvent(new Event("change"));

function loadCrewLinkData(hq, link) {
  const key = `crewData-${hq}-${link}`;
  const stored = localStorage.getItem(key);

  // If available in localStorage, use it
  if (stored) {
    if (!crewLinkData[hq]) crewLinkData[hq] = {};
    crewLinkData[hq][link] = JSON.parse(stored);
  } else {
    // If no saved data, ensure empty array exists
    if (!crewLinkData[hq]) crewLinkData[hq] = {};
    if (!crewLinkData[hq][link]) crewLinkData[hq][link] = [];
  }

  const data = crewLinkData[hq][link];
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${idx + 1}</td>` +
      row.slice(0, 12).map((cell, i) =>
        `<td contenteditable="true" data-col="${i}" onblur="updateRow(this, ${idx})">${cell}</td>`
      ).join('') +
      `<td class="no-print"><button onclick="deleteRow(${idx})" class="text-red-600">🗑️</button></td>`;
    tbody.appendChild(tr);
  });

  updateSummary();
}

function updateRow(td, rowIndex) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const colIndex = parseInt(td.dataset.col);
  const newValue = td.textContent.trim();

  if (!crewLinkData[hq][link]) return;

  // Update memory
  crewLinkData[hq][link][rowIndex][colIndex] = newValue;

  // Recalculate and update if dep, arr, sign-on/off, or day is edited
  if ([3, 4, 5, 6, 12].includes(colIndex)) {
    recalculateRow(rowIndex);
    updateRowDisplay(rowIndex);

    // Recalculate next row to refresh its rest time (depends on this row)
    if (crewLinkData[hq][link][rowIndex + 1]) {
      recalculateRow(rowIndex + 1);
      updateRowDisplay(rowIndex + 1);
    }
  }

  saveToLocalStorage(hq, link);
}

function updateRowDisplay(rowIndex) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const data = crewLinkData[hq][link][rowIndex];
  const row = document.querySelectorAll("#tableBody tr")[rowIndex];

  // Update only recalculated fields
  const fieldsToUpdate = {
    5: data[5], // Sign On
    6: data[6], // Sign Off
    7: data[7], // Duty
    8: data[8], // Night
    9: data[9], // KM
    10: data[10], // HQ Rest
    11: data[11]  // OS Rest
  };

  for (const [colIdx, val] of Object.entries(fieldsToUpdate)) {
    const cell = row.cells[parseInt(colIdx) + 1]; // +1 to skip SL#
    if (cell) cell.textContent = val;
  }

  updateSummary(); // Refresh footer summary
}



// ✅ Export to Excel

function exportExcel() {
  const table = document.getElementById('dutyTable');
  const clone = table.cloneNode(true);

  // Remove no-print and no-export columns
  Array.from(clone.querySelectorAll('tr')).forEach(row => {
    [...row.cells].forEach((cell, i) => {
      if (cell.classList.contains('no-print') || cell.classList.contains('no-export')) {
        row.deleteCell(i);
      }
    });
  });

  // Get Headquarter and Link
  const hq = document.getElementById("hqSelect").value || "HQ";
  const link = document.getElementById("linkSelect").value || "Link";
  const titleText = `${hq} ${link} - Summary`;

  // Create new table with heading row
  const fullTable = document.createElement("table");

  const headingRow = fullTable.insertRow();
  const headingCell = headingRow.insertCell();
  headingCell.colSpan = clone.rows[0].cells.length;
  headingCell.textContent = titleText;
  headingCell.style.fontWeight = "bold";
  headingCell.style.fontSize = "16px";
  headingCell.style.textAlign = "center";
  headingCell.style.padding = "10px";

  fullTable.appendChild(clone.tHead.cloneNode(true));
  fullTable.appendChild(clone.tBodies[0].cloneNode(true));
  if (clone.tFoot) fullTable.appendChild(clone.tFoot.cloneNode(true));

  // Export to Excel
  const wb = XLSX.utils.table_to_book(fullTable, { sheet: "Summary" });
  XLSX.writeFile(wb, `${titleText}.xlsx`);
}
// ✅ Export to PDF


function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });

  const hq = document.getElementById("hqSelect").value || "HQ";
  const link = document.getElementById("linkSelect").value || "Link";
  const titleText = `${hq} ${link} – Summary`;

  const table = document.querySelector("#pdfArea table");
  const headers = [];
  const rows = [];

  // Extract headers (excluding no-print/no-export)
  const headerCells = table.querySelectorAll("thead tr th");
  headerCells.forEach(th => {
    if (!th.classList.contains("no-print") && !th.classList.contains("no-export")) {
      headers.push(th.innerText.trim());
    }
  });

  // Extract body rows
  const bodyRows = table.querySelectorAll("tbody tr");
  bodyRows.forEach(tr => {
    const row = [];
    tr.querySelectorAll("td").forEach((td, index) => {
      const th = headerCells[index];
      if (!th.classList.contains("no-print") && !th.classList.contains("no-export")) {
        row.push(td.innerText.trim());
      }
    });
    rows.push(row);
  });

  // Calculate Totals for Duty Hours, Night Hours, and KM
  let totalDutyMin = 0, totalNightMin = 0, totalKm = 0;
  rows.forEach(row => {
    const duty = row[7]; // Format HH:MM
    const night = row[8];
    const km = row[9];

    if (duty && duty.includes(":")) {
      const [h, m] = duty.split(":").map(Number);
      totalDutyMin += h * 60 + m;
    }

    if (night && night.includes(":")) {
      const [h, m] = night.split(":").map(Number);
      totalNightMin += h * 60 + m;
    }

    if (km && !isNaN(parseInt(km))) {
      totalKm += parseInt(km);
    }
  });

  const totalDays = rows.length;
  const dailyAvgDuty = formatTime(totalDutyMin / totalDays);
  const dailyAvgNight = formatTime(totalNightMin / totalDays);
  const dailyAvgKm = Math.round(totalKm / totalDays);

  const fortnightDuty = formatTime(totalDutyMin);
  const monthlyNight = formatTime(totalNightMin);
  const monthlyKm = totalKm;

  const summaryRow = Array(headers.length).fill('');
  summaryRow[0] = 'Daily Avg:';
  summaryRow[7] = dailyAvgDuty;
  summaryRow[8] = dailyAvgNight;
  summaryRow[9] = dailyAvgKm;

  const summaryRow2 = Array(headers.length).fill('');
  summaryRow2[0] = 'Fortnight Total:';
  summaryRow2[7] = fortnightDuty;
  summaryRow2[8] = monthlyNight;
  summaryRow2[9] = monthlyKm;

  rows.push(summaryRow);
  rows.push(summaryRow2);

  // Centered Heading
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  const pageWidth = doc.internal.pageSize.getWidth();
  const textWidth = doc.getTextWidth(titleText);
  doc.text(titleText, (pageWidth - textWidth) / 2, 15);

  // Table
  doc.autoTable({
    head: [headers],
    body: rows,
    startY: 22,
    theme: 'grid',
    headStyles: { fillColor: [22, 160, 133] },
    styles: {
      fontSize: 9,
      cellPadding: 2,
    },
    margin: { top: 20 },
    didDrawPage: function (data) {
      doc.setFontSize(10);
    }
  });

  doc.save(`${titleText}.pdf`);

  // Helper
  function formatTime(mins) {
    const h = Math.floor(mins / 60);
    const m = Math.round(mins % 60);
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
  }
}


function deleteRow(index) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  crewLinkData[hq][link].splice(index, 1);
  saveToLocalStorage(hq, link);
  loadCrewLinkData(hq, link);
}

function updateSummary() {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const data = crewLinkData[hq]?.[link] || [];

  let totalDutyMin = 0;
  let totalNightMin = 0;
  let totalKm = 0;

  const daySet = new Set();

  for (const row of data) {
    const dutyParts = row[7].split(':').map(Number);
    const nightParts = row[8].split(':').map(Number);
    const kmVal = row[9];
    const dutyDay = row[12];

    if (dutyParts.length === 2) {
      totalDutyMin += dutyParts[0] * 60 + dutyParts[1];
    }

    if (nightParts.length === 2) {
      totalNightMin += nightParts[0] * 60 + nightParts[1];
    }

    if (!isNaN(Number(kmVal))) {
      totalKm += Number(kmVal);
    }

    daySet.add(dutyDay);
  }

  const totalDays = daySet.size || 1; // prevent divide by 0
  
  const avgDuty = Math.round(totalDutyMin / totalDays);
const avgNight = Math.round(totalNightMin / totalDays);
const avgKm = Math.round(totalKm / totalDays);

  // Populate summary rows
  document.getElementById("avgDuty").textContent = formatTime(avgDuty);
  document.getElementById("avgNight").textContent = formatTime(avgNight);
  document.getElementById("avgKm").textContent = avgKm;

  document.getElementById("fortnightDuty").textContent = formatTime(totalDutyMin);
  document.getElementById("fortnightNight").textContent = formatTime(totalNightMin);
  document.getElementById("fortnightKm").textContent = totalKm;

  document.getElementById("monthDuty").textContent = formatTime(totalDutyMin);
  document.getElementById("monthNight").textContent = formatTime(totalNightMin);
  document.getElementById("monthKm").textContent = totalKm;
}

hqSelect.addEventListener("change", () => {
  const hq = hqSelect.value;
  const links = crewLinksByHQ[hq] || [];

  // Reset linkSelect menu
  linkSelect.innerHTML = '<option value="">Select Link</option>';

  links.forEach(link => {
    const opt = document.createElement("option");
    opt.value = link;
    opt.textContent = link;
    linkSelect.appendChild(opt);
  });

  // Clear the table and title until link is selected
  tableBody.innerHTML = "";
  pdfTitle.textContent = `-- ${hq} Summary --`;
});


document.addEventListener("DOMContentLoaded", () => {
  // DOM elements must be defined here
  const hqSelect = document.getElementById("hqSelect");
  const linkSelect = document.getElementById("linkSelect");
  const trainNo = document.getElementById("trainNo");
  const fromStation = document.getElementById("fromStation");
  const toStation = document.getElementById("toStation");
  const departure = document.getElementById("departure");
  const arrival = document.getElementById("arrival");
  const dutyDay = document.getElementById("dutyDay");
  const tableBody = document.getElementById("tableBody");
  const pdfTitle = document.getElementById("pdfTitle");

  // Attach to window to make available globally
  window.hqSelect = hqSelect;
  window.linkSelect = linkSelect;
  window.trainNo = trainNo;
  window.fromStation = fromStation;
  window.toStation = toStation;
  window.departure = departure;
  window.arrival = arrival;
  window.dutyDay = dutyDay;
  window.tableBody = tableBody;
  window.pdfTitle = pdfTitle;

  // Now safe to run init functions
  populateStationDropdowns();
  hqSelect.dispatchEvent(new Event("change"));
});


</script>

</body>
</html>
