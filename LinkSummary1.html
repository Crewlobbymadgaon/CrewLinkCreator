<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crew Link Summary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
    }
    thead {
      background-color: #1e3a8a;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:nth-child(even) { background-color: #f3f4f6; }
    tbody tr:hover { background-color: #e0f2fe; }
    td[contenteditable="true"]:focus {
      background-color: #e0f2fe;
      outline: 2px solid #2563eb;
    }
    @media print {
      .no-print { display: none !important; }
    }
   
  @media print {
    thead { display: table-header-group; }
  }
  
</style>

</head>
<body class="bg-gray-100 text-sm"><main class="max-w-7xl mx-auto p-4">
 <h1 class="text-xl font-bold mb-6 text-center">Crew Link Summary</h1>
 
  <!-- Input Section -->  
  
  <div class="bg-white p-6 rounded-xl shadow-md mb-8">
  <h2 class="text-xl font-bold mb-4 text-center text-blue-800">Add New Duty</h2>

  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    
    <!-- Headquarter -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Headquarter</span>
      <select id="hqSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="MAO">MAO</option>
        <option value="RN">RN</option>
        <option value="SL">SL</option>
      </select>
    </label>

    <!-- Crew Link -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Crew Link</span>
      <select id="linkSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Link</option>
      </select>
    </label>


    <!-- Train No -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Train No</span>
      <input id="trainNo" placeholder="Train No" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
    </label>

    <!-- From Station -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">From Station</span>
      <select id="fromStation" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">From</option>
      </select>
    </label>

    <!-- To Station -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">To Station</span>
      <select id="toStation" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">To</option>
      </select>
    </label>

    <!-- Duty Day -->
    <label class="block">
      <span class="block text-sm font-semibold text-gray-700 mb-1">Day of Duty</span>
      <select id="dutyDay" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Day</option>
        <option>Mon</option><option>Tue</option><option>Wed</option>
        <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
      </select>
    </label>

  </div>
</div>


  <button onclick="addRow()" class="mt-4 bg-blue-600 text-white w-full sm:w-auto px-6 py-2 rounded shadow hover:bg-blue-700">
    ‚ûï Add Duty Row
  </button>
</div>

  </div>  
  
  <!-- PDF Export Area --> 
  
  <div id="pdfArea" class="bg-white p-4">
    <h1 id="pdfTitle" class="text-xl font-bold mb-4 text-center">Summary</h1>
    <div>
      <table id="dutyTable" class="min-w-full text-center table-auto border-collapse">
        <thead>
          <tr>
            <th>#</th><th>Train</th><th>From</th><th>To</th><th>Departure</th><th>Arrival</th>
            <th>Sign On</th><th>Sign Off</th><th>Duty Hrs</th><th>Night Hrs</th><th>KM</th>
            <th>HQ Rest</th><th>OS Rest</th><th class="no-print">üóëÔ∏è</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        
        <!-- Separated Bottom Summary Table -->
<div id="summaryTableWrapper" class="mt-4">
  <table id="summaryTable" class="min-w-full text-center border-collapse">
    <thead class="bg-gray-500 font-semibold">
      <tr>
        <th colspan="8" class="text-right pr-2">Summary Type</th>
        <th>Duty Hrs</th>
        <th>Night Hrs</th>
        <th>KM</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Avg / Day</td>
        <td id="avgDuty">--</td>
        <td id="avgNight">--</td>
        <td id="avgKm">--</td>
      </tr>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Fortnight</td>
        <td id="fortnightDuty">--</td>
        <td id="fortnightNight">--</td>
        <td id="fortnightKm">--</td>
      </tr>
      <tr>
        <td colspan="8" class="text-right pr-2 font-semibold">Month</td>
        <td id="monthDuty">--</td>
        <td id="monthNight">--</td>
        <td id="monthKm">--</td>
      </tr>
      <tr class="bg-yellow-100 font-bold">
        <td colspan="8" class="text-right pr-2">Total</td>
        <td id="totalDuty">--</td>
        <td id="totalNight">--</td>
        <td id="totalKm">--</td>
      </tr>
    </tbody>
  </table>
</div>



      </table>
    </div>
    
    </div>

 
  
<div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
  <button onclick="exportExcel()" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700">
    üìä Export to Excel
  </button>
  <button onclick="exportPDF()" class="bg-red-600 text-white px-6 py-2 rounded shadow hover:bg-red-700">
    üßæ Export to PDF
  </button>
</div>


  

</main>

<script>
const trainTimings = {
    "MAO-MAQ": [
      { train: "20645", dep: "17:35", arr: "22:45" },
      { train: "12619", dep: "02:35", arr: "10:20" },
      { train: "56615", dep: "14:15", arr: "21:55" },
      { train: "SP/56615", dep: "14:15", arr: "21:55" },
      { train: "SP/20645", dep: "17:35", arr: "22:45" },
      { train: "SP/10107/10107", dep: "04:40", arr: "12:30" }
    ],
    "MAQ-MAO": [
      { train: "20646", dep: "08:30", arr: "14:10" },
      { train: "56616", dep: "05:30", arr: "13:30" },
      { train: "12620", dep: "12:45", arr: "19:30" },
      { train: "10108/SP", dep: "15:30", arr: "23:15" },
      { train: "16585/SP", dep: "08:40", arr: "19:30" },
      { train: "SP/20646", dep: "08:30", arr: "14:10" },
      { train: "12789/SP", dep: "09:30", arr: "19:30" }
    ],
    "MAO-RN": [
      { train: "12052", dep: "12:00", arr: "17:20" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "12431", dep: "08:00", arr: "12:40" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22907", dep: "10:00", arr: "14:45" },
      { train: "12977", dep: "09:20", arr: "14:45" },
      { train: "22633", dep: "08:00", arr: "12:45" },
      { train: "12224", dep: "09:55", arr: "15:25" },
      { train: "16334", dep: "10:50", arr: "16:05" },
      { train: "16336", dep: "10:50", arr: "16:05" },
      { train: "16338", dep: "10:50", arr: "16:05" },
      { train: "19259", dep: "10:50", arr: "16:05" },
      { train: "16312", dep: "10:50", arr: "16:05" },
      { train: "12283", dep: "11:35", arr: "16:25" },
      { train: "22149", dep: "15:50", arr: "20:20" },
      { train: "22655", dep: "15:50", arr: "20:20" },
      { train: "22653", dep: "15:50", arr: "20:20" },
      { train: "22114", dep: "18:20", arr: "23:20" },
      { train: "12620", dep: "19:40", arr: "23:30" },
      { train: "12134", dep: "22:10", arr: "02:20" },
      { train: "12217", dep: "23:40", arr: "04:50" },
      { train: "22659", dep: "23:40", arr: "04:50" },
      { train: "12483", dep: "23:40", arr: "04:50" },
      { train: "12617", dep: "01:20", arr: "06:00" },
      { train: "12202", dep: "01:55", arr: "06:50" },
      { train: "19577", dep: "02:25", arr: "07:55" },
      { train: "22630", dep: "04:25", arr: "09:55" },
      { train: "20923", dep: "02:40", arr: "07:55" },
      { train: "20931", dep: "02:40", arr: "07:55" },
      { train: "20909", dep: "02:40", arr: "07:55" },
      { train: "22476", dep: "02:40", arr: "07:55" },
      { train: "16346", dep: "04:00", arr: "09:00" },
      { train: "10116", dep: "07:40", arr: "13:30" },
      { train: "10104", dep: "08:30", arr: "14:00" },
      { train: "22414", dep: "08:00", arr: "12:40" },
      { train: "20907", dep: "10:00", arr: "14:45" },
      { train: "12449", dep: "10:00", arr: "14:45" },
      { train: "11100", dep: "11:30", arr: "16:30" },
      { train: "22230", dep: "12:20", arr: "16:55" },
      { train: "22120", dep: "12:50", arr: "18:05" },
      { train: "20112", dep: "18:00", arr: "22:50" },
      { train: "12741", dep: "20:05", arr: "00:40" },
      { train: "22413", dep: "08:00", arr: "12:40" },
      { train: "02197", dep: "05:35", arr: "10:25" },
      { train: "50108/10106", dep: "06:20", arr: "12:00" }
      
        ],
  
    "RN-MAO": [
      { train: "12051", dep: "11:25", arr: "16:40" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22150", dep: "02:25", arr: "06:45" },
      { train: "12133", dep: "04:20", arr: "09:00" },
      { train: "22656", dep: "06:55", arr: "12:30" },
      { train: "12432", dep: "03:55", arr: "08:25" },
      { train: "22414", dep: "03:55", arr: "08:35" },
      { train: "16333", dep: "05:15", arr: "10:40" },
      { train: "16335", dep: "05:15", arr: "10:40" },
      { train: "16337", dep: "05:15", arr: "10:40" },
      { train: "19260", dep: "05:15", arr: "10:40" },
      { train: "20111", dep: "06:05", arr: "11:40" },
      { train: "22654", dep: "06:55", arr: "12:30" },
      { train: "12450", dep: "07:30", arr: "13:30" },
      { train: "11099", dep: "08:25", arr: "14:40" },
      { train: "12978", dep: "10:45", arr: "15:50" },
      { train: "22229", dep: "10:45", arr: "16:00" },
      { train: "22119", dep: "12:05", arr: "17:20" },
      { train: "12618", dep: "12:45", arr: "17:50" },
      { train: "12484", dep: "13:25", arr: "18:25" },
      { train: "22660", dep: "13:25", arr: "18:25" },
      { train: "12218", dep: "13:25", arr: "18:25" },
      { train: "10103", dep: "14:50", arr: "21:55" },
      { train: "10115", dep: "16:10", arr: "22:40" },
      { train: "20932", dep: "17:00", arr: "22:50" },
      { train: "20910", dep: "17:00", arr: "22:50" },
      { train: "19578", dep: "17:00", arr: "22:50" },
      { train: "16345", dep: "18:35", arr: "23:45" },
      { train: "22908", dep: "17:00", arr: "22:50" },
      { train: "16311", dep: "20:35", arr: "01:45" },
      { train: "22475", dep: "20:35", arr: "01:45" },
      { train: "12284", dep: "20:35", arr: "01:45" },
      { train: "12619", dep: "21:35", arr: "02:25" },
      { train: "20924", dep: "22:10", arr: "03:10" },
      { train: "22634", dep: "22:10", arr: "03:10" },
      { train: "12201", dep: "23:35", arr: "04:00" },
      { train: "22113", dep: "23:35", arr: "04:00" },
      { train: "12742", dep: "23:35", arr: "04:00" },
      { train: "12223", dep: "02:25", arr: "06:20" },
      { train: "20629", dep: "03:15", arr: "08:25" },
      { train: "20932", dep: "17:00", arr: "23:00" },
      { train: "22629", dep: "03:15", arr: "08:25" },
      { train: "09057", dep: "06:25", arr: "12:20" },
      { train: "10105/50107", dep: "14:05", arr: "21:30" }
      
    ],
    
    "MAO-MAJN": [
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22629", dep: "08:35", arr: "14:05" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "10215", dep: "21:00", arr: "03:00" },
  { train: "12432", dep: "08:35", arr: "14:05" },
  { train: "12133", dep: "09:10", arr: "15:40" },
  { train: "16333", dep: "10:50", arr: "17:55" },
  { train: "16335", dep: "10:50", arr: "17:55" },
  { train: "16337", dep: "10:50", arr: "17:55" },
  { train: "19260", dep: "10:50", arr: "17:55" },
  { train: "22654", dep: "12:40", arr: "18:15" },
  { train: "22656", dep: "12:40", arr: "18:15" },
  { train: "12978", dep: "16:00", arr: "21:45" },
  { train: "12618", dep: "18:00", arr: "23:35" },
  { train: "12484", dep: "18:35", arr: "01:10" },
  { train: "22660", dep: "18:35", arr: "01:10" },
  { train: "12218", dep: "18:35", arr: "01:10" },
  { train: "20932", dep: "23:00", arr: "04:10" },
  { train: "20910", dep: "23:00", arr: "04:10" },
  { train: "19578", dep: "23:00", arr: "04:10" },
  { train: "16345", dep: "23:55", arr: "05:45" },
  { train: "16311", dep: "01:55", arr: "09:15" },
  { train: "22475", dep: "01:55", arr: "09:15" },
  { train: "12284", dep: "01:55", arr: "09:20" },
  { train: "20924", dep: "03:20", arr: "09:45" },
  { train: "22634", dep: "03:20", arr: "09:45" },
  { train: "12201", dep: "04:10", arr: "10:25" },
  { train: "22113", dep: "04:10", arr: "10:25" },
  { train: "12223", dep: "06:30", arr: "12:15" },
  { train: "22150", dep: "06:55", arr: "13:45" },
  { train: "11097", dep: "13:10", arr: "19:20" },
  { train: "09057", dep: "12:30", arr: "19:45" },
  { train: "SP/16345", dep: "23:55", arr: "05:45" }
  
  ],
    "MAJN-MAO": [
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "12431", dep: "01:50", arr: "07:50" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12977", dep: "01:50", arr: "09:10" },
      { train: "22633", dep: "01:55", arr: "07:50" },
      { train: "12224", dep: "04:00", arr: "09:45" },
      { train: "16334", dep: "04:10", arr: "10:40" },
      { train: "16336", dep: "04:10", arr: "10:40" },
      { train: "16338", dep: "04:10", arr: "10:40" },
      { train: "19259", dep: "04:10", arr: "10:40" },
      { train: "16312", dep: "04:10", arr: "10:50" },
      { train: "12283", dep: "06:05", arr: "11:25" },
      { train: "22149", dep: "09:25", arr: "15:40" },
      { train: "22655", dep: "09:30", arr: "15:40" },
      { train: "22653", dep: "09:30", arr: "15:40" },
      { train: "22114", dep: "12:00", arr: "18:10" },
      { train: "12134", dep: "16:35", arr: "22:00" },
      { train: "12217", dep: "17:10", arr: "23:30" },
      { train: "22659", dep: "17:10", arr: "23:30" },
      { train: "12483", dep: "17:10", arr: "23:30" },
      { train: "12617", dep: "19:00", arr: "01:10" },
      { train: "12202", dep: "19:15", arr: "01:45" },
      { train: "19577", dep: "20:00", arr: "02:15" },
      { train: "22630", dep: "22:00", arr: "04:15" },
      { train: "20923", dep: "20:00", arr: "02:30" },
      { train: "20931", dep: "20:00", arr: "02:30" },
      { train: "20909", dep: "20:00", arr: "02:30" },
      { train: "22476", dep: "20:00", arr: "02:30" },
      { train: "16346", dep: "21:35", arr: "03:50" },
      { train: "11098", dep: "01:55", arr: "09:30" },
      { train: "10216", dep: "20:20", arr: "03:30" },
      { train: "SP/16312", dep: "04:10", arr: "10:50" },
      { train: "SP/56616", dep: "05:45", arr: "13:30" },
      { train: "02197", dep: "23:10", arr: "05:25" },
      { train: "09058", dep: "22:10", arr: "05:10" }
    ],
    "RN-SWV": [
      { train: "11003", dep: "09:05", arr: "12:50" }
    ],
     "SWV-RN": [
      { train: "11004", dep: "17:55", arr: "21:30" }
    ],
     "RN-KRMI": [
      { train: "22115", dep: "07:30", arr: "12:25" }
    ],
     "KRMI-RN": [
      { train: "22116", dep: "13:40", arr: "18:05" }
    ],
    "SL-MAO": [
      { train: "16595/01595", dep: "03:37", arr: "10:25" },
      { train: "SP/56616", dep: "06:28", arr: "13:30" },
      { train: "SP/12134", dep: "17:08", arr: "22:00" }
    ],
    "SL-MAQ": [
      { train: "16585/16586", dep: "09:50", arr: "18:25" }
      
    ],
    "MAO-SL": [
      { train: "01596/16596", dep: "16:30", arr: "21:54" }
    ],
    "MAQ-SL": [
      { train: "16585", dep: "08:40", arr: "09:48" }
    ],
     "MAO-MRDW": [
      { train: "10107", dep: "04:40", arr: "07:42" },
      { train: "SP/10107", dep: "04:40", arr: "07:42" }
    ],
     "MRDW-MAO": [
      { train: "10108", dep: "18:41", arr: "23:15" },
      { train: "SP/10108", dep: "18:41", arr: "23:15" }
      
    ],
     "MRDW-MAQ": [
      { train: "16586", dep: "14:25", arr: "18:25" },
      { train: "12790", dep: "15:45", arr: "19:45" },
      { train: "10107", dep: "07:43", arr: "12:20" }
      
    ],
     "MAQ-MRDW": [
      { train: "10108", dep: "15:30", arr: "18:40" },
      { train: "16585", dep: "08:40", arr: "13:50" },
      { train: "12789", dep: "09:30", arr: "15:10" }
    ],
     "RN-ROH": [
      { train: "10106", dep: "12:05", arr: "17:20" },
      { train: "50104", dep: "05:40", arr: "10:55" }
    ],
     "ROH-RN": [
      { train: "50103", dep: "20:12", arr: "02:00" },
      { train: "10105", dep: "09:05", arr: "14:00" }
    ],
    "MAO-VSG": [
      { train: "12742", dep: "04:15", arr: "05:45" }
    ],
    
    "VSG-MAO": [
      { train: "12741", dep: "19:00", arr: "19:50" }
      ],
     "MAO-KAWR": [
      { train: "70101", dep: "19:00", arr: "20:30" }
    ],
     "KAWR-MAO": [
      { train: "70102", dep: "06:00", arr: "07:15" }
    ],
    
         "MAQ-SL": [
      { train: "16585", dep: "08:40", arr: "09:48" }
    ]
    
};

const crewLinkMen = {
  MAO: {
    "Link 1": 18,
    "Link 2": 15,
    "Link 3": 10,
    "Link 4": 17
  },
  RN: {
    "Link 1": 14,
    "Link 2": 17,
    "Link 3": 15
  },
  SL: {
    "Link 1": 2
  }
};



// ‚úÖ Constants
const stations = ['MAO', 'RN', 'MAJN', 'MAQ', 'MRDW', 'SL', 'KAWR', 'ROH', 'VSG'];
const kmMap = {
  'MAO-RN': 239, 'RN-MAO': 239,
  'MAO-MAJN': 312, 'MAJN-MAO': 312,
  'MAO-MAQ': 318, 'MAQ-MAO': 318,
  'MAO-MRDW': 154, 'MRDW-MAO': 154,
  'MAO-KAWR': 120, 'KAWR-MAO': 120,
  'MAQ-MRDW': 164, 'MRDW-MAQ': 164,
  'MAO-SL': 294, 'SL-MAO': 294
};

const crewLinksByHQ = {
  MAO: ["Link 1", "Link 2", "Link 3", "Link 4"],
  RN: ["Link 1", "Link 2", "Link 3"],
  SL: ["Link 1"]
};

const crewLinkData = { MAO: {}, RN: {}, SL: {} };
const dayToIndex = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };

function parseTime(t) {
  let [h, m] = t.split(":" ).map(Number);
  if (h === 24 && m === 0) return 0;
  return h * 60 + m;
}

function formatTime(mins) {
  if (isNaN(mins)) return "--";
  const h = Math.floor(mins / 60).toString().padStart(2, '0');
  const m = (mins % 60).toString().padStart(2, '0');
  return `${h}:${m}`;
}

function parseDayTime(dayStr, timeStr) {
  const [hRaw, mRaw] = timeStr.split(':').map(Number);
  const base = new Date(Date.UTC(2025, 0, 5));
  base.setUTCDate(base.getUTCDate() + dayToIndex[dayStr]);
  base.setUTCHours(hRaw % 24, mRaw, 0, 0);
  if (hRaw === 24 && mRaw === 0) base.setUTCDate(base.getUTCDate() + 1);
  return base;
}

function getRestMinutes(prevDay, prevSignOff, currDay, currSignOn) {
  const prevDate = parseDayTime(prevDay, prevSignOff);
  const currDate = parseDayTime(currDay, currSignOn);
  let diff = (currDate - prevDate) / 60000;
  if (diff < 0) diff += 7 * 1440;
  return diff;
}

function calcNightHours(start, end) {
  let total = 0;
  for (let i = 0; i < (end - start + 1440) % 1440; i++) {
    const min = (start + i) % 1440;
    if (min >= 1320 || min < 360) total++;
  }
  return total;
}

function populateStationDropdowns() {
  fromStation.innerHTML = '<option value="">From</option>';
  toStation.innerHTML = '<option value="">To</option>';
  stations.forEach(st => {
    fromStation.innerHTML += `<option value="${st}">${st}</option>`;
    toStation.innerHTML += `<option value="${st}">${st}</option>`;
  });
}

function adjustSignOffDay(startDay, depTime, signOffTime) {
  const depMin = parseTime(depTime);
  const signOffMin = parseTime(signOffTime);
  let shift = signOffMin < depMin ? 1 : 0;
  const newIndex = (dayToIndex[startDay] + shift) % 7;
  return Object.keys(dayToIndex).find(k => dayToIndex[k] === newIndex);
}

function addRow() {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const train = trainNo.value.trim();
  const from = fromStation.value;
  const to = toStation.value;
  const day = dutyDay.value;
  if (!hq || !link || !train || !from || !to || !day) return alert("Fill all fields");

  const directionKey = `${from}-${to}`;
  const timingsList = trainTimings[directionKey] || [];
  const timing = timingsList.find(t => t.train === train);
  if (!timing) return alert("Train timing not found for selected HQ and route.");

  const dep = timing.dep;
  const arr = timing.arr;
  let signOnMin = parseTime(dep) - 30;
  if (signOnMin < 0) signOnMin += 1440;
  let signOffMin = parseTime(arr) + 30;
  if (signOffMin >= 1440) signOffMin -= 1440;

  const signOn = formatTime(signOnMin);
  const signOff = formatTime(signOffMin);
  let dutyMin = signOffMin - signOnMin;
  if (dutyMin < 0) dutyMin += 1440;

  const duty = formatTime(dutyMin);
  const night = formatTime(calcNightHours(signOnMin, signOffMin));
  const km = kmMap[directionKey] || '--';

  if (!crewLinkData[hq][link]) crewLinkData[hq][link] = [];
  const data = crewLinkData[hq][link];

  let hqRest = '--', osRest = '--';
  if (data.length > 0) {
    const prev = data[data.length - 1];
    const actualPrevSignOffDay = adjustSignOffDay(prev[12], prev[3], prev[6]);
    const restMin = getRestMinutes(actualPrevSignOffDay, prev[6], day, signOn);
    if (prev[2] === hq && from === hq) hqRest = formatTime(restMin);
    else osRest = formatTime(restMin);
  }

  const row = [train, from, to, dep, arr, signOn, signOff, duty, night, km, hqRest, osRest, day];
  data.push(row);
  saveToLocalStorage(hq, link);
  loadCrewLinkData(hq, link);

  trainNo.value = '';
  fromStation.value = '';
  toStation.value = '';
  dutyDay.value = '';
}

function loadCrewLinkData(hq, link) {
  const key = `crewData-${hq}-${link}`;
  const stored = localStorage.getItem(key);
  if (stored) crewLinkData[hq][link] = JSON.parse(stored);
  else crewLinkData[hq][link] = [];

  const data = crewLinkData[hq][link];
  tableBody.innerHTML = "";

  data.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${idx + 1}</td>` +
      row.slice(0, 12).map((cell, i) =>
        `<td contenteditable="true" data-col="${i}" onblur="updateRow(this, ${idx})">${cell}</td>`
      ).join('') +
      `<td class="no-print"><button onclick="deleteRow(${idx})" class="text-red-600">üóëÔ∏è</button></td>`;
    tableBody.appendChild(tr);
  });

  updateSummary();
}

function updateRow(td, rowIndex) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const colIndex = parseInt(td.dataset.col);
  const newValue = td.textContent.trim();

  if (!crewLinkData[hq] || !crewLinkData[hq][link]) return;

  // Validate KM column
  if (colIndex === 9 && (isNaN(newValue) || newValue === "")) {
    alert("Please enter a valid number for KM.");
    td.textContent = crewLinkData[hq][link][rowIndex][colIndex]; // restore original
    return;
  }

  // Save new value
  crewLinkData[hq][link][rowIndex][colIndex] = newValue;

  // Recalculate if column affects time/KM/rest
  const recalcCols = [3, 4, 5, 6, 9, 12]; // dep, arr, sign on/off, km, day
  if (recalcCols.includes(colIndex)) {
    recalculateRow(rowIndex);        // Update logic
    updateRowDisplay(rowIndex);      // Update visible row
  }

  saveToLocalStorage(hq, link);
}





function updateRowDisplay(rowIndex) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const data = crewLinkData[hq][link][rowIndex];
  const row = document.querySelectorAll("#tableBody tr")[rowIndex];

  const fieldsToUpdate = {
    5: data[5],  // Sign On
    6: data[6],  // Sign Off
    7: data[7],  // Duty
    8: data[8],  // Night
    9: data[9],  // KM
    10: data[10], // HQ Rest
    11: data[11]  // OS Rest
  };

  for (const [colIdx, val] of Object.entries(fieldsToUpdate)) {
    const cell = row.cells[parseInt(colIdx) + 1]; // +1 because first cell is SL#
    if (cell) cell.textContent = val;
  }

  updateSummary(); // Refresh footer summary
}



function recalculateRow(idx) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const data = crewLinkData[hq][link];
  if (!data || !data[idx]) return;

  const row = data[idx];

  const train = row[0];
  const from = row[1];
  const to = row[2];
  const dep = row[3];
  const arr = row[4];
  const manualSignOn = row[5];
  const manualSignOff = row[6];
  const day = row[12];

  // Sign On
  let signOnMin;
  if (manualSignOn && /^\d{1,2}:\d{2}$/.test(manualSignOn)) {
    signOnMin = parseTime(manualSignOn);
  } else {
    signOnMin = parseTime(dep) - 30;
    if (signOnMin < 0) signOnMin += 1440;
    row[5] = formatTime(signOnMin);
  }

  // Sign Off
  let signOffMin;
  if (manualSignOff && /^\d{1,2}:\d{2}$/.test(manualSignOff)) {
    signOffMin = parseTime(manualSignOff);
  } else {
    signOffMin = parseTime(arr) + 30;
    if (signOffMin >= 1440) signOffMin -= 1440;
    row[6] = formatTime(signOffMin);
  }

  // Duty Time
  let dutyMin = signOffMin - signOnMin;
  if (dutyMin < 0) dutyMin += 1440;
  row[7] = formatTime(dutyMin);

  // Night Hours
  row[8] = formatTime(calcNightHours(signOnMin, signOnMin + dutyMin));

  // KM
  if (!row[9] || row[9] === '--') {
  row[9] = kmMap[`${from}-${to}`] || '--';
}


  // Rest
  let hqRest = '--', osRest = '--';
  if (idx > 0) {
    const prev = data[idx - 1];
    const prevDepDay = prev[12];
    const prevDepTime = prev[3];
    const prevSignOff = prev[6];
    const prevTo = prev[2];

    const actualPrevSignOffDay = adjustSignOffDay(prevDepDay, prevDepTime, prevSignOff);
    const restMin = getRestMinutes(actualPrevSignOffDay, prevSignOff, day, row[5]);

    if (prevTo === hq && from === hq) hqRest = formatTime(restMin);
    else osRest = formatTime(restMin);
  }

  row[10] = hqRest;
  row[11] = osRest;
}


function updateSummary() {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  const data = crewLinkData[hq]?.[link] || [];

  let totalDutyMin = 0, totalNightMin = 0, totalKm = 0;

  for (const row of data) {
    const dutyParts = row[7].split(':').map(Number);
    const nightParts = row[8].split(':').map(Number);
    const kmVal = parseInt(row[9]);

    if (dutyParts.length === 2) totalDutyMin += dutyParts[0] * 60 + dutyParts[1];
    if (nightParts.length === 2) totalNightMin += nightParts[0] * 60 + nightParts[1];
    if (!isNaN(kmVal)) totalKm += kmVal;
  }

  const men = crewLinkMen?.[hq]?.[link] || 1;
  const totalDays = 7 * men;

  const avgDuty = Math.round(totalDutyMin / totalDays);
  const avgNight = Math.round(totalNightMin / totalDays);
  const avgKm = Math.round(totalKm / totalDays);

  avgDutyEl.textContent = formatTime(avgDuty);
  avgNightEl.textContent = formatTime(avgNight);
  avgKmEl.textContent = avgKm;

  fortnightDuty.textContent = formatTime(avgDuty * 14);
  fortnightNight.textContent = formatTime(avgNight * 14);
  fortnightKm.textContent = avgKm * 14;

  monthDuty.textContent = formatTime(avgDuty * 30);
  monthNight.textContent = formatTime(avgNight * 30);
  monthKm.textContent = avgKm * 30;

  totalDuty.textContent = formatTime(totalDutyMin);
  totalNight.textContent = formatTime(totalNightMin);
  totalKmEl.textContent = totalKm;

}


function saveToLocalStorage(hq, link) {
  localStorage.setItem(`crewData-${hq}-${link}`, JSON.stringify(crewLinkData[hq][link]));
}

function deleteRow(index) {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  crewLinkData[hq][link].splice(index, 1);
  saveToLocalStorage(hq, link);
  loadCrewLinkData(hq, link);
}

hqSelect.addEventListener("change", () => {
  const hq = hqSelect.value;
  const links = crewLinksByHQ[hq] || [];
  linkSelect.innerHTML = '<option value="">Select Link</option>';
  links.forEach(link => {
    const opt = document.createElement("option");
    opt.value = link;
    opt.textContent = link;
    linkSelect.appendChild(opt);
  });
  tableBody.innerHTML = "";
  pdfTitle.textContent = `-- ${hq} Summary --`;
});

linkSelect.addEventListener("change", () => {
  const hq = hqSelect.value;
  const link = linkSelect.value;
  if (!hq || !link) return;
  pdfTitle.textContent = `${hq} ${link} - Summary`;
  loadCrewLinkData(hq, link);
});

function exportPDF() {
  const element = document.getElementById("pdfArea");

  const hq = document.getElementById("hqSelect").value || "HQ";
  const link = document.getElementById("linkSelect").value || "Link";
  const titleText = `${hq} ${link} - Summary`;

  // Set title only for first page
  document.getElementById("pdfTitle").textContent = titleText;

  // Temporarily hide buttons, delete icons, etc.
  const toHide = document.querySelectorAll(".no-print, .no-export");
  toHide.forEach(el => {
    el.dataset.originalDisplay = el.style.display;
    el.style.display = "none";
  });

  // Apply table header style
  const style = document.createElement("style");
  style.textContent = `
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    table { width: 100%; border-collapse: collapse; }
    td, th {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }
    tbody tr:nth-child(even) {
      background-color: #f0f0f0;
    }
    h1#pdfTitle {
      text-align: center;
      font-size: 16px;
      margin-bottom: 10px;
    }
  `;
  document.head.appendChild(style);

  // Export PDF
  html2pdf()
    .set({
      margin: [10, 8, 10, 8], // top, left, bottom, right
      filename: `${titleText}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    })
    .from(element)
    .toPdf()
    .get('pdf')
    .then(pdf => {
      const totalPages = pdf.internal.getNumberOfPages();
      for (let i = 2; i <= totalPages; i++) {
        pdf.setPage(i);
        pdf.setFontSize(10);
        pdf.setTextColor(100);
        pdf.text(`${titleText} ‚Äî Page ${i}`, pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - 8, { align: 'center' });
      }
    })
    .save()
    .then(() => {
      // Restore hidden elements
      toHide.forEach(el => {
        el.style.display = el.dataset.originalDisplay || "";
      });
      document.head.removeChild(style);
    });
}


function exportExcel() {
  const table = document.getElementById("dutyTable");
  const clone = table.cloneNode(true);

  // Remove buttons or extra columns
  Array.from(clone.querySelectorAll("tr")).forEach(row => {
    [...row.cells].forEach((cell, i) => {
      if (cell.classList.contains("no-print") || cell.classList.contains("no-export")) {
        row.deleteCell(i);
      }
    });
  });

  // Extract HQ and Link
  const hq = document.getElementById("hqSelect").value || "HQ";
  const link = document.getElementById("linkSelect").value || "Link";
  const titleText = `${hq} ${link} - Summary`;

  // Add title row above table
  const fullTable = document.createElement("table");
  const headingRow = fullTable.insertRow();
  const headingCell = headingRow.insertCell();
  headingCell.colSpan = clone.rows[0].cells.length;
  headingCell.textContent = titleText;
  headingCell.style.fontWeight = "bold";
  headingCell.style.fontSize = "16px";
  headingCell.style.textAlign = "center";
  headingCell.style.padding = "10px";

  fullTable.appendChild(clone.tHead.cloneNode(true));
  fullTable.appendChild(clone.tBodies[0].cloneNode(true));
  if (clone.tFoot) fullTable.appendChild(clone.tFoot.cloneNode(true));

  // Export using SheetJS
  const wb = XLSX.utils.table_to_book(fullTable, { sheet: "Summary" });
  XLSX.writeFile(wb, `${titleText}.xlsx`);
}



document.addEventListener("DOMContentLoaded", () => {
  window.hqSelect = document.getElementById("hqSelect");
  window.linkSelect = document.getElementById("linkSelect");
  window.trainNo = document.getElementById("trainNo");
  window.fromStation = document.getElementById("fromStation");
  window.toStation = document.getElementById("toStation");
  window.dutyDay = document.getElementById("dutyDay");
  window.tableBody = document.getElementById("tableBody");
  window.pdfTitle = document.getElementById("pdfTitle");
  window.avgDutyEl = document.getElementById("avgDuty");
  window.avgNightEl = document.getElementById("avgNight");
  window.avgKmEl = document.getElementById("avgKm");
  window.fortnightDuty = document.getElementById("fortnightDuty");
  window.fortnightNight = document.getElementById("fortnightNight");
  window.fortnightKm = document.getElementById("fortnightKm");
  window.monthDuty = document.getElementById("monthDuty");
  window.monthNight = document.getElementById("monthNight");
  window.monthKm = document.getElementById("monthKm");
  window.totalDuty = document.getElementById("totalDuty");
  window.totalNight = document.getElementById("totalNight");
  window.totalKm = document.getElementById("totalKm");
  window.totalKmEl = document.getElementById("totalKm");


  populateStationDropdowns();
  hqSelect.dispatchEvent(new Event("change"));
});

</script>

</body>
</html>
